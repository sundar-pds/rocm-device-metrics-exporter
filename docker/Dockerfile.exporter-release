ARG BASE_IMAGE=registry.access.redhat.com/ubi9/ubi-minimal:9.6

FROM ${BASE_IMAGE}

LABEL maintainer="AMD Inc"
LABEL OS="registry.access.redhat.com/ubi9/ubi-minimal:9.6"
LABEL ROCM_VERSION="7.0_rc1"


ARG ROCM_VERSION=7.0
ARG AMDGPU_VERSION=7.0
ARG AMDGPU_REPO_URL=https://repo.radeon.com

RUN microdnf clean all && \
   echo "[amdgpu]" > /etc/yum.repos.d/amdgpu.repo && \
   echo "name=AMDGPU repository" >> /etc/yum.repos.d/amdgpu.repo && \
   echo "baseurl=${AMDGPU_REPO_URL}/graphics/${AMDGPU_VERSION}/rhel/9.6/main/x86_64/" >> /etc/yum.repos.d/amdgpu.repo && \
   echo "enabled=1" >> /etc/yum.repos.d/amdgpu.repo && \
   echo "priority=50" >> /etc/yum.repos.d/amdgpu.repo && \
   echo "gpgcheck=1" >> /etc/yum.repos.d/amdgpu.repo && \
   echo "gpgkey=${AMDGPU_REPO_URL}/rocm/rocm.gpg.key" >> /etc/yum.repos.d/amdgpu.repo && \
   echo "[ROCm-${ROCM_VERSION}]" > /etc/yum.repos.d/rocm.repo && \
   echo "name=ROCm${ROCM_VERSION}" >> /etc/yum.repos.d/rocm.repo && \
   echo "baseurl=${AMDGPU_REPO_URL}/rocm/rhel9/${AMDGPU_VERSION}/main" >> /etc/yum.repos.d/rocm.repo && \
   echo "enabled=1" >> /etc/yum.repos.d/rocm.repo && \
   echo "priority=50" >> /etc/yum.repos.d/rocm.repo && \
   echo "gpgcheck=1" >> /etc/yum.repos.d/rocm.repo && \
   echo "gpgkey=${AMDGPU_REPO_URL}/rocm/rocm.gpg.key" >> /etc/yum.repos.d/rocm.repo && \
   microdnf update -y && \
   microdnf install -y sudo findutils procps elfutils-libelf cmake kmod file tar \
   libcap-devel amd-smi-lib libdrm-amdgpu vim net-tools numactl numactl-libs \
   hsa-amd-aqlprofile rocprofiler-sdk hip-runtime-amd jq iproute ethtool && \
   rm -rf /var/cache/yum && rm -rf /var/cache/dnf && microdnf clean all


ENV PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/home/amd/bin/:/opt/rocm/bin/:/opt/nic/bin:/opt/nic/sbin
ENV LD_LIBRARY_PATH=/opt/rocm/lib:$LD_LIBRARY_PATH
RUN mkdir -p /home/amd/bin/
RUN mkdir -p /home/amd/lib/
RUN mkdir -p /home/amd/tools/

# Clean up existing AMD SMI libraries and add custom ones
RUN rm -f /opt/rocm/lib/libamd_smi.so*
ADD ./libamd_smi.so.25.4 /opt/rocm/lib/libamd_smi.so.25.4
RUN cd /opt/rocm/lib && \
    ln -sf libamd_smi.so.25.4 libamd_smi.so.25 && \
    ln -sf libamd_smi.so.25 libamd_smi.so

# override built libraries
ADD ./librocpclient.so /opt/rocm/lib/librocpclient.so
ADD ./libamd_smi.so.25.4 /home/amd/lib/libamd_smi.so.25.4
RUN cd /home/amd/lib/ && ln -sf libamd_smi.so.25.4 libamd_smi.so.25

ADD ./rocpctl /home/amd/bin/rocpctl
ADD ./gpuctl /home/amd/bin/gpuctl
ADD ./gpuagent /home/amd/bin/gpuagent
ADD ./amd-metrics-exporter /home/amd/bin/server
ADD ./metricsclient /home/amd/bin/metricsclient
ADD ./amdgpuhealth /home/amd/bin/amdgpuhealth
ADD ./entrypoint.sh /home/amd/tools/entrypoint.sh
RUN chmod +x /home/amd/tools/entrypoint.sh
ADD ./metrics-exporter-ts.sh /home/amd/bin/metrics-exporter-ts.sh
RUN chmod +x /home/amd/bin/metrics-exporter-ts.sh

LABEL name="amd-device-metrics-exporter" \ 
    maintainer="praveenkumar.shanmugam@amd.com,nitish.bhat@amd.com,yan.sun3@amd.com,shrey.ajmera@amd.com" \
    vendor="Advanced Micro Devices, Inc." \
    version="v1.5.0" \
    release="v1.5.0" \
    summary="AMD Device Metrics Exporter enables out-of-the-box metrics collection for AMD GPUs on Kubernetes." \
    description="AMD Device Metrics Exporter enables Prometheus-format metrics collection for AMD GPUs in HPC and AI environments. It provides detailed telemetry including temperature, utilization, memory usage, and power consumption."

ENTRYPOINT ["/home/amd/tools/entrypoint.sh"]
